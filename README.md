# 实践报告

## 设计思路与原理说明

### 设计目标

  1. 实现**波轮**控制的可调12v降压输出用于驱动风机  
  1. 尽量使用电源芯片自带的负反馈机制 实现良好**动态响应**  
  1. 尝试提供**高效率** **低纹波**的单片机供电  
  1. 提供oled显示**目标电压**  
  1. 体积尽可能小  
  1. 尽量使用全贴片元件 有利于反面 *彩色丝印* 的呈现  

### 电路结构设计&原理说明  

  1. 使用开关电源 LDO二级单片机供电 实现高效率低噪声  
   一级输出:
   ![一级输出](./src/IMG_20251201_135449.jpg)
   二级输出:
   ![二级输出](./src/IMG_20251201_143532.jpg)
  2. 单片机供电一级调整为3.6v输出 为ldo压降提供空间
  3. 使用单片机配合数字电位器控制电压反馈网络调节功率开关电源 从而利用其自带的负反馈机制实现良好**动态响应**
  4. 为数字电位器spi oled iic通信布线  
  5. 为数字电位器设置5v TVS二极管 防止电压调节或启动中的异常电压损坏数字电位器  
  6. 为电源输出配置TVS二极管 防止电机停转的反电动势击穿  

### 元件选型理由

   1. TPS54061 3.3v供电一级(12-3.6v) 效率高 体积小 尝试SON8封装 尝试频率设置等多引脚硬件配置
   2. TPS7A2033 3.3v供电二级(3.6v-3.3v)低噪声LDO 1khz高达**95dB**降噪  压降低有利于降低3.3v电源一级输出电压提高效率  
   3. TPS5430DDAR 功率输出 广泛使用的功率输出  
   4. STM32L010F4P6 引脚数量适当 体积小 易于焊接 有低功耗特性 利于没有总开关的系统长时间待机  
   5. TPL0501 数字电位器 256位数字电位器中最便宜的
   6. oled 0.91寸 大小适当 功耗低  
   7. 其余各种贴片 防止破坏反面的*彩色丝印*
   8. 大量使用TI电源芯片 TI提供在线电源**自动**设计软件 有利于快速设计  
   TPS54061周边电路设计:
   ![TPS54061周边电路设计](./src/2025-12-10113603.png)
   [TI Power Designer](https://webench.ti.com/power-designer/)  

## PCB布局布线考虑
  
  1. 功能分区与原件分区接近 有利于布线 如3.3v供电集中在电源输入上部 功率电源集中在电源输出附近 而控制部分介于两者之前
  ![电路布局](./src/屏幕截图%202025-12-10%20114027.png)
  2. 大电流路径加宽 铺铜时大电流焊盘专门设置普通规则 大电流走线加粗至30mil以上 大电流接地布置大量过孔  
  3. 基于**俺寻思之力**的EMI优化 在v3 版本中给地平面切了一刀 将功率电源的高频大电流回流路径限制在下半部分 缓解噪声直接通过地传播到控制部分的同时减小环路面积从而减小EMI  
  ![地平面分割](./src/屏幕截图%202025-12-10%20114045.png)
  4. 斜着放置STM32 有利于 缩短走线距离 压缩pcb面积  
  5. 大小电容基本按照由大到小的规则放置 tvs二极管尽可能接近需要保护的期间或是可能的浪涌来源  
  6. 手动删除接地不良的铺铜区 防止不良影响  
  7. 结合3D模型合理控制元件间距 防止**焊接难度**过大  

## 遇到的问题&解决方案

  1. 嘉立创电源封装 二极管封装有问题 换封装重打pcb解决
  2. spi连别不上 排查波形后定位到片选信号问题 硬件NSS output有问题多次尝试无法修复 改用手动配置GPIO解决  
  ![spi波形](./src/IMG_20251203_145313.jpg)
  3. oled驱动占用内存过大 移植困难 从头手搓了刚好够用的oled驱动解决  
  4. 添加定时自动熄屏的时候报错内存不足 搜索代码后没有发现使用malloc 把堆删了节省512Byte空间解决  
  5. 调试时电脑3.3v供电与板载3.3v供电可能因为电压不同引起电源倒灌 调试时不连3.3v只共地 且tps7A20的精度高 一定程度上可忽略  
  6. oled接触不良跑飞 加入了IWDG
  7. 神人芯片GPIO初始化有问题[^1]导致自动复位后仍有电源输出 手动在初始化函数之间加入HAL_GPIO_WritePin解决

[^1]:cubeMX设置为pushpull 输出低电平 看了初始化函数也没问题,复位后电源使能还是高电平

## 成品

风机带载2h无明显发热 调压 熄屏 关闭输出等功能一切正常
 ![成品图片](./src/IMG_20251204_165448.jpg)
 彩色丝印:![丝印图片](./src/IMG_20251204_165335.jpg)
 
